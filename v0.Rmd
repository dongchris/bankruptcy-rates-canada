---
title: "Untitled"
author: "Kerem Turgutlu"
date: "November 26, 2017"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = F, message = F, cache = T)
```

```{r}
library(tidyverse)
library(forecast)
library(lawstat)
library(tseries)
```



```{r}
train <- read.csv('train.csv')[1:288,]
test <- read.csv('test.csv')
```

```{r}
train %>% glimpse()
```


```{r}
train_ts <- ts(train,start = 1987, frequency = 12)
test_ts <- ts(test, start = 2011, frequency = 12)
```


```{r}
plot(train_ts)
```

There is great correlation between House_Price_Index and Bankruptcy_Rate, probably even a higher one with lagged values of House_Price_Index.


```{r}
cor(train)
```


```{r}
lagged.cor <- c()

h = 50
for (i in (seq(h))){
  lagged_house <- lag(train$House_Price_Index, n = i)
  cor.i <- cor(lagged_house, train$Bankruptcy_Rate, use = 'complete.obs')
  lagged.cor <- c(lagged.cor, cor.i)
}
```


## Lagged Correlation Plot h vs Correlation

```{r}
best.idx <- which.max(lagged.cor)
plot(lagged.cor)
points(best.idx, lagged.cor[best.idx], col='red')
title('House_Price_Index VS Bankruptcy_Rate')
```


## SARIMA MODEL

```{r}
bankruptcy_ts <- ts(train$Bankruptcy_Rate, frequency = 12)
```


```{r}
length(bankruptcy_ts) /12
```

#### Split train - valid (Last 2 Years as Valid)


```{r}
bank.train.ts <- ts(bankruptcy_ts[1:264], frequency = 12)
bank.valid.ts <- ts(bankruptcy_ts[265:288], frequency = 12)
```

#### Plot Training

```{r}
plot(bank.train.ts)
```

Try log transform, looks better.

```{r}
bank.train.ts.log <- log(bank.train.ts)
bank.valid.ts.log <- log(bank.valid.ts)
plot(log(bank.train.ts))
```


Do 1 diff

```{r}
ndiffs(bank.train.ts.log)
bank.train.ts.log.D10 <- diff(bank.train.ts.log)
ndiffs(bank.train.ts.log.D10)
nsdiffs(bank.train.ts.log.D10)
```

There seem to be no seasonality and ts is now stationary

```{r}
adf.test(bank.train.ts.log.D10)
```


```{r}
acf(bank.train.ts.log.D10, lag.max = 60)
```

```{r}
pacf(bank.train.ts.log.D10, 60)
```



Check auto.arima and acf plots, if any suggestions try out other models. Model seems reasonable.

```{r}
auto.arima(bank.train.ts.log, d=1)
```

```{r}
arima.model.312.100 <- arima(bank.train.ts.log, order = c(3, 1, 2), seasonal = c(1, 0, 0))
```

Define rmse and make predictions

```{r}
#rmse
rmse <- function(true, preds){return(sqrt(mean((true - preds)**2)))}

#preds
valid.preds <- forecast(arima.model.312.100, length(bank.valid.ts))
valid.rmse <- rmse(as.numeric(exp(valid.preds$mean)), bank.valid.ts)
paste(valid.rmse)
```

```{r}
#plot predictions
plot(valid.preds)
```




















